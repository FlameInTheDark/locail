name: Release

on:
  # Trigger when a GitHub Release is published (works if release event is emitted)
  release:
    types: [published]
  # Allow being called as a reusable workflow
  workflow_call:
    inputs: {}
  # Trigger after the Semantic Release workflow completes (works even when release events from GITHUB_TOKEN are suppressed)
  workflow_run:
    workflows: ["Semantic Release"]
    types: [completed]
  # Manual trigger
  workflow_dispatch: {}

permissions:
  contents: write

env:
  CGO_ENABLED: "1"

jobs:
  meta:
    name: Determine version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.setver.outputs.version }}
    steps:
      - id: setver
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName
            let version = ''
            // If this was triggered by a published release, use that tag directly
            if (eventName === 'release') {
              version = context.payload?.release?.tag_name || ''
            }
            // For workflow_run, prefer successful runs of the Semantic Release workflow,
            // but still fall back to the latest published release if available.
            if (!version && eventName === 'workflow_run') {
              const wr = context.payload?.workflow_run || {}
              // We continue and try to read the latest release even if cancelled/skipped
            }
            // Fallback: read latest published release tag
            try {
              const { data } = await github.rest.repos.getLatestRelease({ owner: context.repo.owner, repo: context.repo.repo })
              if (!version) version = data.tag_name || ''
            } catch (e) {
              // ignore; no release found
            }
            if (!version) {
              core.setOutput('version', '')
              return
            }
            core.setOutput('version', version)
  build-windows:
    name: Windows (amd64)
    runs-on: windows-latest
    needs: meta
    env:
      VERSION: ${{ needs.meta.outputs.version }}
    if: needs.meta.outputs.version != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install NSIS & UPX
        run: |
          choco install nsis -y
          choco install upx -y

      - name: Install Wails CLI
        shell: pwsh
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest
          $env:Path += ';' + (go env GOPATH) + '\\bin'

      - name: Frontend install
        shell: pwsh
        run: |
          cd frontend
          npm ci

      - name: Build (wails + UPX + NSIS)
        shell: pwsh
        run: |
          # Try with UPX maximum compression; fallback to non-UPX if it fails
          wails build -clean -upx -upxflags '-9 --best --lzma' -nsis -ldflags "-s -w -X main.version=$env:VERSION"
          if ($LASTEXITCODE -ne 0) {
            wails build -clean -nsis -ldflags "-s -w -X main.version=$env:VERSION"
          }

      - name: Collect artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          $zipName = "locail_${env:VERSION}_windows_amd64.zip"
          Compress-Archive -Path build\bin\* -DestinationPath (Join-Path artifacts $zipName)
          # Copy NSIS installer if present and rename with version
          $installer = Get-ChildItem -Path build\bin -Include *installer*.exe,*setup*.exe -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($null -ne $installer) {
            Copy-Item $installer.FullName (Join-Path artifacts ("locail_${env:VERSION}_windows_amd64_installer.exe"))
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: locail_windows_amd64
          path: artifacts/*
          if-no-files-found: warn

  build-linux:
    name: Linux (amd64)
    runs-on: ubuntu-latest
    needs: meta
    env:
      VERSION: ${{ needs.meta.outputs.version }}
    if: needs.meta.outputs.version != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install system deps (GTK/WebKit/UPX)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libgtk-3-dev libglib2.0-dev libayatana-appindicator3-dev librsvg2-dev
          # WebKitGTK dev package (4.1 on newer Ubuntu, fallback to 4.0)
          sudo apt-get install -y libwebkit2gtk-4.1-dev || sudo apt-get install -y libwebkit2gtk-4.0-dev
          sudo apt-get install -y upx

      - name: Detect WebKitGTK version
        run: |
          if pkg-config --exists webkit2gtk-4.1; then echo "WAILS_TAGS=webkitgtk_4_1" >> $GITHUB_ENV; else echo "WAILS_TAGS=" >> $GITHUB_ENV; fi

      - name: Shim pkg-config alias for webkit2gtk-4.0 -> 4.1 (if needed)
        run: |
          if pkg-config --exists webkit2gtk-4.1 && ! pkg-config --exists webkit2gtk-4.0; then \
            mkdir -p "$HOME/pc"; \
            cat > "$HOME/pc/webkit2gtk-4.0.pc" <<-'EOF'
	prefix=/usr
	exec_prefix=${prefix}
	libdir=${exec_prefix}/lib
	includedir=${prefix}/include
	Name: WebKitGTK
	Description: Compatibility shim mapping 4.0 to 4.1
	Version: 4.0
	Requires: webkit2gtk-4.1
	Cflags:
	Libs:
EOF
            echo "PKG_CONFIG_PATH=$HOME/pc:${PKG_CONFIG_PATH}" >> $GITHUB_ENV; \
          fi

      - name: Install Wails CLI
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Frontend install
        run: |
          cd frontend
          npm ci

      - name: Build (wails + UPX)
        run: |
          # Try with UPX maximum compression; fallback to non-UPX if it fails
          wails build -clean ${WAILS_TAGS:+-tags "$WAILS_TAGS"} -upx -upxflags "-9 --best --lzma" -ldflags "-s -w -X main.version=${VERSION}" || \
          wails build -clean ${WAILS_TAGS:+-tags "$WAILS_TAGS"} -ldflags "-s -w -X main.version=${VERSION}"

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          tar -C build/bin -czf artifacts/locail_${VERSION}_linux_amd64.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: locail_linux_amd64
          path: artifacts/*
          if-no-files-found: warn

  build-macos:
    name: macOS (amd64)
    runs-on: macos-13
    needs: meta
    env:
      VERSION: ${{ needs.meta.outputs.version }}
    if: needs.meta.outputs.version != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install UPX
        run: |
          brew update
          brew install upx || true

      - name: Install Wails CLI
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Frontend install
        run: |
          cd frontend
          npm ci

      - name: Build (wails + UPX)
        run: |
          # Try with UPX; if it fails on Mach-O, fall back to normal build
          wails build -clean -upx -upxflags "-9 --best --lzma" -ldflags "-s -w -X main.version=${VERSION}" || \
          wails build -clean -ldflags "-s -w -X main.version=${VERSION}"

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          ditto -c -k --sequesterRsrc --keepParent build/bin artifacts/locail_${VERSION}_macos_amd64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: locail_macos_amd64
          path: artifacts/*
          if-no-files-found: warn

  build-macos-arm64:
    name: macOS (arm64)
    runs-on: macos-14
    needs: meta
    env:
      VERSION: ${{ needs.meta.outputs.version }}
    if: needs.meta.outputs.version != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install UPX
        run: |
          brew update
          brew install upx || true

      - name: Install Wails CLI
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Frontend install
        run: |
          cd frontend
          npm ci

      - name: Build (wails + UPX)
        env:
          GOARCH: arm64
        run: |
          wails build -clean -upx -upxflags "-9 --best --lzma" -ldflags "-s -w -X main.version=${VERSION}" || \
          wails build -clean -ldflags "-s -w -X main.version=${VERSION}"

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          ditto -c -k --sequesterRsrc --keepParent build/bin artifacts/locail_${VERSION}_macos_arm64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: locail_macos_arm64
          path: artifacts/*
          if-no-files-found: warn

  publish:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: [meta, build-windows, build-linux, build-macos, build-macos-arm64]
    if: needs.meta.outputs.version != ''
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd release_assets
          sha256sum * > SHA256SUMS.txt

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.meta.outputs.version }}
          files: |
            release_assets/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
